name: ccpp

on:
  push:
    branches:
      - main
    paths:
      - "template/C-Cpp/**"
  workflow_dispatch:

jobs:
  deploy_template:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Get short commit SHA
        id: vars
        run: echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
      - name: "Install latest Coder"
        run: |
          curl -L https://coder.com/install.sh | sh
        # env:
        #   VERSION: 0.x
      - name: "Push template"
        run: |
          coder templates push --directory $CODER_TEMPLATE_DIR --yes --name=$CODER_TEMPLATE_VERSION
        env:
          # Consumed by Coder CLI
          CODER_URL: https://coder.cfouche-serv.fr
          CODER_SESSION_TOKEN: ${{ secrets.CODER_SESSION_TOKEN }}
          # Template source & detail
          CODER_TEMPLATE_VERSION: ${{ steps.vars.outputs.sha_short }}
          CODER_TEMPLATE_DIR: ./template/C-Cpp